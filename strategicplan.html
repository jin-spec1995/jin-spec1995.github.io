<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Strategic Plan Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  
  <style>
    body { background:#f6f7f9; font-family: sans-serif; }
    .card { background:#fff; border-radius:16px; box-shadow:0 6px 28px rgba(0,0,0,.06); }
    .section-title { border-left:4px solid #0e6f57; padding-left:.75rem; }
    .muted { color:#64748b; }
    .btn { border-radius:9999px; padding:.7rem 1.2rem; font-weight:600; cursor:pointer; transition: background-color 0.2s; }
    .btn-primary { background:#0e6f57; color:#fff; }
    .btn-primary:hover { background:#0b5a45; }
    .btn-secondary { background:#e2e8f0; color:#1e293b; }
    .btn-secondary:hover { background:#cbd5e1; }
    .group { background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:1.25rem; }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:.75rem }
    .grid-3 { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:.75rem }
    textarea { min-height: 120px; }
    input, textarea { border:1px solid #cbd5e1; outline-color:#0e6f57; }
    .small { font-size:.85rem }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-5xl mx-auto card p-5 md:p-8">
    <header class="mb-8">
      <h1 class="text-2xl md:text-3xl font-bold">Strategic Plan Generator üìù</h1>
      <p class="muted">
        Fill out the questionnaire below. When you're done, click "Generate Word Document" to download your strategic plan.
      </p>
    </header>

    <section class="mb-8">
      <h2 class="section-title text-xl font-semibold mb-4">Title Page & Business Basics</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label for="bizName" class="block font-medium mb-1">Full Business Name (<<5>>)</label>
          <input id="bizName" class="w-full border rounded-lg p-2" value="Brisbane Computer Solutions Pty Ltd (BCS)"/>
        </div>
        <div>
          <label for="tradingName" class="block font-medium mb-1">Trading Name (<<6>>)</label>
          <input id="tradingName" class="w-full border rounded-lg p-2" value="BCS"/>
        </div>
         <div>
          <label for="authorName" class="block font-medium mb-1">Author Name</label>
          <input id="authorName" class="w-full border rounded-lg p-2" value="Keith Davidson"/>
        </div>
        <div>
          <label for="bizType" class="block font-medium mb-1">Business Type (<<7>>)</label>
          <input id="bizType" class="w-full border rounded-lg p-2" value="Managed Services provider"/>
        </div>
        <div>
          <label for="firstYear" class="block font-medium mb-1">First Year of Operation (<<8>>)</label>
          <input id="firstYear" class="w-full border rounded-lg p-2" value="2010"/>
        </div>
        <div>
          <label for="geo" class="block font-medium mb-1">Geographic Location (<<9>>)</label>
          <input id="geo" class="w-full border rounded-lg p-2" value="The Northern Suburbs of Brisbane"/>
        </div>
        <div>
          <label for="primaryMarket" class="block font-medium mb-1">Primary Target Market (<<10>>)</label>
          <input id="primaryMarket" class="w-full border rounded-lg p-2" value="Small to Medium Enterprises"/>
        </div>
        <div>
          <label for="primaryArea" class="block font-medium mb-1">Primary Market Area (<<11>>)</label>
          <input id="primaryArea" class="w-full border rounded-lg p-2" value="Northern Brisbane Area"/>
        </div>
        <div>
          <label for="secondaryMarket" class="block font-medium mb-1">Secondary Target Market (<<12>>)</label>
          <input id="secondaryMarket" class="w-full border rounded-lg p-2" value="Professional service firms"/>
        </div>
        <div>
          <label for="secondaryArea" class="block font-medium mb-1">Secondary Market Area (<<13>>)</label>
          <input id="secondaryArea" class="w-full border rounded-lg p-2" value="Greater Brisbane North"/>
        </div>
        <div class="md:col-span-2">
          <label for="imageUrl" class="block font-medium mb-1">Business Image URL (for title page) (<<14>>)</label>
          <input id="imageUrl" class="w-full border rounded-lg p-2" value="https://images.pexels.com/photos/3184418/pexels-photo-3184418.jpeg"/>
        </div>
      </div>
    </section>

    <section class="mb-8">
      <h2 class="section-title text-xl font-semibold mb-4">Executive Summary & Strategic Overview</h2>
      <div>
        <label for="businessDescription" class="block font-medium mb-1">Business Description (<<15>>)</label>
        <textarea id="businessDescription" class="w-full border rounded-lg p-3">We avoid the ‚ÄòBreak/Fix‚Äô model that our industry operates on; we remain a leading, trustworthy choice for computer repair services and I.T. solutions. We also believe in being adaptable to our clients‚Äô needs, knowing that every problem requires a tailored solution, and are thus capable of providing remote support and performing site visits. We are a Managed Services Provider; we specialise in I.T. support and computer networking services to businesses, computer repairs and upgrades, fast custom builds, powerful workstations, and removal of unnecessary hardware and software from your machines. We are I.T. experts.</textarea>
      </div>
      <div class="mt-4">
        <label for="background" class="block font-medium mb-1">Business Background (<<17>>)</label>
        <textarea id="background" class="w-full border rounded-lg p-3">BCS was founded to deliver dependable, proactive I.T. services to SMEs. Since 2010, we‚Äôve grown through word-of-mouth and long-term relationships, focusing on uptime, security and right-sized solutions that scale with clients.</textarea>
      </div>
      <div class="mt-4">
        <label for="serviceIntent" class="block font-medium mb-1">Service Delivery Intent (<<18>>)</label>
        <textarea id="serviceIntent" class="w-full border rounded-lg p-3">Always strive to exceed expectations. Follow-ups, complimentary visits where needed, warranties on all projects, and ‚Äúwe turn up when we say‚Äù.</textarea>
      </div>
    </section>

    <section class="mb-8">
      <h2 class="section-title text-xl font-semibold mb-4">Strategic Purpose & Direction</h2>
      <div>
        <label for="purpose" class="block font-medium mb-1">Strategic Purpose (Why does the business exist?) (<<19>>)</label>
        <textarea id="purpose" class="w-full border rounded-lg p-3">BCS provides managed I.T. services so SMEs can become the success they want to be‚Äîempowering them with secure, reliable technology and expert support.</textarea>
      </div>
      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div>
          <label for="planningPeriod" class="block font-medium mb-1">Planning Period (<<22>>)</label>
          <input id="planningPeriod" class="w-full border rounded-lg p-2" value="3 years (FY2025‚ÄìFY2027)"/>
        </div>
        <div>
          <label for="planningGoal" class="block font-medium mb-1">Planning Period Goal (<<22 Planning period Goal>>)</label>
          <input id="planningGoal" class="w-full border rounded-lg p-2" value="have 1000 devices"/>
        </div>
        <div>
          <label for="detailedPeriod" class="block font-medium mb-1">Detailed Planning Period (<<23>>)</label>
          <input id="detailedPeriod" class="w-full border rounded-lg p-2" value="the end of the next 12 months."/>
        </div>
        <div>
          <label for="detailedGoal" class="block font-medium mb-1">Detailed Planning Period Goal (<<24>>)</label>
          <input id="detailedGoal" class="w-full border rounded-lg p-2" value="500 devices"/>
        </div>
      </div>
    </section>

    <section class="mb-8">
      <h2 class="section-title text-xl font-semibold mb-4">Values</h2>
      <div>
        <label for="valuesStatement" class="block font-medium mb-1">Values Statement (<<25>>)</label>
        <textarea id="valuesStatement" class="w-full border rounded-lg p-3">We place Integrity and Learning above all else. We communicate plainly and deliver proactive managed services designed around our clients‚Äô needs.</textarea>
      </div>
      <div class="group mt-4">
        <div class="flex items-center justify-between mb-3">
          <div class="font-medium">Values (up to 5)</div>
          <button class="btn btn-secondary" type="button" id="addValueBtn">+ Add Value</button>
        </div>
        <div id="valuesList" class="space-y-4"></div>
      </div>
    </section>

    <section class="mb-8">
      <h2 class="section-title text-xl font-semibold mb-4">Stakeholders</h2>
      <div>
        <label for="stakeholderStatement" class="block font-medium mb-1">Stakeholder Statement (<<42>>)</label>
        <textarea id="stakeholderStatement" class="w-full border rounded-lg p-3">We consider the needs of our internal and external stakeholders and align procedures to enhance performance and outcomes for all.</textarea>
      </div>
      <div class="group mt-4">
        <div class="flex items-center justify-between mb-3">
          <div class="font-medium">Stakeholders</div>
          <button class="btn btn-secondary" type="button" id="addStakeBtn">+ Add Stakeholder</button>
        </div>
        <div id="stakeList" class="space-y-4"></div>
      </div>
    </section>
    
    <section class="mb-10">
        <h2 class="section-title text-xl font-semibold mb-4">Strategic Analysis - Issues Identification</h2>
        <!-- Sales Issues -->
        <div class="group mt-4">
            <div class="flex items-center justify-between mb-3">
                <div class="font-medium">Sales Issues (up to 5)</div>
                <button class="btn btn-secondary" type="button" id="addSalesIssueBtn">+ Add Sales Issue</button>
            </div>
            <div id="salesIssuesList" class="space-y-4"></div>
        </div>
        <!-- Finance Issues -->
        <div class="group mt-6">
            <div class="flex items-center justify-between mb-3">
                <div class="font-medium">Finance Issues (up to 5)</div>
                <button class="btn btn-secondary" type="button" id="addFinanceIssueBtn">+ Add Finance Issue</button>
            </div>
            <div id="financeIssuesList" class="space-y-4"></div>
        </div>
        <!-- Operation Issues -->
        <div class="group mt-6">
            <div class="flex items-center justify-between mb-3">
                <div class="font-medium">Operation Issues (up to 5)</div>
                <button class="btn btn-secondary" type="button" id="addOperationIssueBtn">+ Add Operation Issue</button>
            </div>
            <div id="operationIssuesList" class="space-y-4"></div>
        </div>
        <!-- Learning Issues -->
        <div class="group mt-6">
            <div class="flex items-center justify-between mb-3">
                <div class="font-medium">Learning Issues (up to 5)</div>
                <button class="btn btn-secondary" type="button" id="addLearningIssueBtn">+ Add Learning Issue</button>
            </div>
            <div id="learningIssuesList" class="space-y-4"></div>
        </div>
        <!-- Growth Issues -->
        <div class="group mt-6">
            <div class="flex items-center justify-between mb-3">
                <div class="font-medium">Growth Issues (up to 5)</div>
                <button class="btn btn-secondary" type="button" id="addGrowthIssueBtn">+ Add Growth Issue</button>
            </div>
            <div id="growthIssuesList" class="space-y-4"></div>
        </div>
    </section>

    <div class="flex items-center justify-start gap-4 p-4 bg-gray-50 rounded-lg">
      <button class="btn btn-primary" id="generateBtn" type="button">üöÄ Generate Word Document</button>
      <button class="btn btn-secondary" id="saveBtn" type="button">‚òÅÔ∏è Save Plan to Cloud</button>
      <span id="saveStatus" class="muted small"></span>
    </div>
  </div>

<script type="module">
// ---------- Firebase Configuration ----------
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Your web app's Firebase configuration from your project
const firebaseConfig = {
    apiKey: "AIzaSyA4O3haWqOcuobxmbeqgYoGFgTN1mS_tWA",
    authDomain: "strategicplan-fef14.firebaseapp.com",
    projectId: "strategicplan-fef14",
    storageBucket: "strategicplan-fef14.appspot.com", // Corrected storage bucket
    messagingSenderId: "431924618661",
    appId: "1:431924618661:web:9a3e585862bdea70c1744c",
    measurementId: "G-5F7688FKQE"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


// ---------- Helper Functions ----------
function el(html) {
    const t = document.createElement('template');
    t.innerHTML = html.trim();
    return t.content.firstChild;
}

// Function to add a new generic issue row
function addIssueRow(listId, itemName, def = { issue: "", cause: "" }) {
    const list = document.getElementById(listId);
    if (list.children.length >= 5) return;
    const placeholder = list.children.length + 1;
    list.appendChild(el(`
        <div class="p-3 border rounded-lg bg-white ${itemName.toLowerCase()}-issue-item">
            <div class="font-semibold mb-2 text-gray-700">${itemName} Issue ${placeholder}</div>
            <div class="grid-2">
                <input class="border rounded-lg p-2" placeholder="Issue (from identification process)" value="${def.issue}"/>
                <input class="border rounded-lg p-2" placeholder="What is the cause and how can it be resolved?" value="${def.cause}"/>
            </div>
        </div>
    `));
}


// Function to add a new "Value" row to the form
function addValueRow(def = { value: "", principle: "", behaviour: "" }) {
    const list = document.getElementById('valuesList');
    if (list.children.length >= 5) return;
    const placeholder = list.children.length + 1;
    list.appendChild(el(`
        <div class="p-3 border rounded-lg bg-white value-item">
            <div class="font-semibold mb-2 text-gray-700">Value ${placeholder}</div>
            <div class="grid-3">
                <input class="border rounded-lg p-2" placeholder="Value (e.g., Integrity)" value="${def.value}"/>
                <input class="border rounded-lg p-2" placeholder="Principle" value="${def.principle}"/>
                <input class="border rounded-lg p-2" placeholder="Behaviour" value="${def.behaviour}"/>
            </div>
        </div>
    `));
}

// Function to add a new "Stakeholder" row to the form
function addStakeRow(def = { who: "", stake: "" }) {
    const list = document.getElementById('stakeList');
    if (list.children.length >= 6) return; // As per original template
    const placeholder = list.children.length + 1;
    list.appendChild(el(`
        <div class="p-3 border rounded-lg bg-white stake-item">
            <div class="font-semibold mb-2 text-gray-700">Stakeholder ${placeholder}</div>
            <div class="grid-2">
                <input class="border rounded-lg p-2" placeholder="Stakeholder (e.g., Customers)" value="${def.who}"/>
                <input class="border rounded-lg p-2" placeholder="What is their stake in the business?" value="${def.stake}"/>
            </div>
        </div>
    `));
}

// Function to gather all data from the form into an object
function getPlanData() {
    return {
        bizName: document.getElementById('bizName').value.trim(),
        tradingName: document.getElementById('tradingName').value.trim(),
        authorName: document.getElementById('authorName').value.trim(),
        bizType: document.getElementById('bizType').value.trim(),
        firstYear: document.getElementById('firstYear').value.trim(),
        geo: document.getElementById('geo').value.trim(),
        primaryMarket: document.getElementById('primaryMarket').value.trim(),
        primaryArea: document.getElementById('primaryArea').value.trim(),
        secondaryMarket: document.getElementById('secondaryMarket').value.trim(),
        secondaryArea: document.getElementById('secondaryArea').value.trim(),
        imageUrl: document.getElementById('imageUrl').value.trim(),
        businessDescription: document.getElementById('businessDescription').value.trim(),
        background: document.getElementById('background').value.trim(),
        serviceIntent: document.getElementById('serviceIntent').value.trim(),
        purpose: document.getElementById('purpose').value.trim(),
        planningPeriod: document.getElementById('planningPeriod').value.trim(),
        planningGoal: document.getElementById('planningGoal').value.trim(),
        detailedPeriod: document.getElementById('detailedPeriod').value.trim(),
        detailedGoal: document.getElementById('detailedGoal').value.trim(),
        valuesStatement: document.getElementById('valuesStatement').value.trim(),
        stakeholderStatement: document.getElementById('stakeholderStatement').value.trim(),
        values: Array.from(document.querySelectorAll('.value-item')).map(r => {
            const [v, p, b] = r.querySelectorAll('input');
            return { v: v.value.trim(), p: p.value.trim(), b: b.value.trim() };
        }),
        stakeholders: Array.from(document.querySelectorAll('.stake-item')).map(r => {
            const [who, stake] = r.querySelectorAll('input');
            return { who: who.value.trim(), stake: stake.value.trim() };
        }),
        salesIssues: Array.from(document.querySelectorAll('.sales-issue-item')).map(r => {
            const [issue, cause] = r.querySelectorAll('input');
            return { issue: issue.value.trim(), cause: cause.value.trim() };
        }),
        financeIssues: Array.from(document.querySelectorAll('.finance-issue-item')).map(r => {
            const [issue, cause] = r.querySelectorAll('input');
            return { issue: issue.value.trim(), cause: cause.value.trim() };
        }),
        operationIssues: Array.from(document.querySelectorAll('.operation-issue-item')).map(r => {
            const [issue, cause] = r.querySelectorAll('input');
            return { issue: issue.value.trim(), cause: cause.value.trim() };
        }),
        learningIssues: Array.from(document.querySelectorAll('.learning-issue-item')).map(r => {
            const [issue, cause] = r.querySelectorAll('input');
            return { issue: issue.value.trim(), cause: cause.value.trim() };
        }),
        growthIssues: Array.from(document.querySelectorAll('.growth-issue-item')).map(r => {
            const [issue, cause] = r.querySelectorAll('input');
            return { issue: issue.value.trim(), cause: cause.value.trim() };
        }),
    };
}


// Attach event listeners to the "Add" buttons
document.getElementById('addValueBtn').addEventListener('click', () => addValueRow());
document.getElementById('addStakeBtn').addEventListener('click', () => addStakeRow());
document.getElementById('addSalesIssueBtn').addEventListener('click', () => addIssueRow('salesIssuesList', 'Sales'));
document.getElementById('addFinanceIssueBtn').addEventListener('click', () => addIssueRow('financeIssuesList', 'Finance'));
document.getElementById('addOperationIssueBtn').addEventListener('click', () => addIssueRow('operationIssuesList', 'Operation'));
document.getElementById('addLearningIssueBtn').addEventListener('click', () => addIssueRow('learningIssuesList', 'Learning'));
document.getElementById('addGrowthIssueBtn').addEventListener('click', () => addIssueRow('growthIssuesList', 'Growth'));


// Pre-fill the form with some example data for demonstration
addValueRow({ value: "Integrity", principle: "We do the right thing, even when unseen.", behaviour: "We uphold ethical standards in every action." });
addValueRow({ value: "Learning", principle: "We continuously improve and share knowledge.", behaviour: "We invest in training and apply learnings to client outcomes." });
addStakeRow({ who: "Customers", stake: "Reliable support, clear communication, and predictable positive outcomes." });
addStakeRow({ who: "Employees", stake: "A safe workload, clear processes, and opportunities for growth." });
addIssueRow('salesIssuesList', 'Sales', { issue: "Lead conversion rate is dropping", cause: "Follow-up process is inconsistent. Resolve by implementing a CRM and a structured follow-up schedule." });
addIssueRow('financeIssuesList', 'Finance', { issue: "Cash flow is unpredictable", cause: "Invoice payments are often delayed. Resolve by offering early payment discounts and stricter follow-up on overdue invoices." });
addIssueRow('operationIssuesList', 'Operation', { issue: "Project delivery times are slipping", cause: "Lack of standardized project management process. Resolve by implementing a project management tool and methodology." });
addIssueRow('learningIssuesList', 'Learning', { issue: "Staff skills gaps in new technologies", cause: "No formal training plan. Resolve by creating a professional development budget and plan for each team member." });
addIssueRow('growthIssuesList', 'Growth', { issue: "Struggling to enter new market segment", cause: "Brand awareness is low in the target segment. Resolve by launching a targeted marketing campaign and forming strategic partnerships." });


// ---------- Save to Firestore Logic ----------
document.getElementById('saveBtn').addEventListener('click', async () => {
    const saveStatus = document.getElementById('saveStatus');
    saveStatus.textContent = 'Saving...';
    saveStatus.style.color = '#64748b'; // Muted color
    
    const planData = getPlanData();
    planData.savedAt = serverTimestamp(); // Use the imported function

    try {
        const docRef = await addDoc(collection(db, "strategic_plans"), planData);
        saveStatus.textContent = `Plan saved successfully!`;
        saveStatus.style.color = '#0e6f57'; // Green
    } catch (error) {
        console.error("Error adding document: ", error);
        saveStatus.textContent = 'Error saving plan. Check console & Firestore rules.';
        saveStatus.style.color = '#be123c'; // Red
    }
});


// ---------- DOCX Generation Logic ----------
document.getElementById('generateBtn').addEventListener('click', async () => {
  
 const {
    AlignmentType, Document, Footer, HeadingLevel, ImageRun, Packer, Paragraph, ShadingType, TextRun,
    PageNumber, Table, TableCell, TableRow, WidthType, BorderStyle, TableOfContents
    } = docx;

    // --- Styling Constants from Template ---
    const SHADE_SECTION = "C5E0B3"; 
    const SHADE_SUBHEAD = "E2EFD9"; 
    const BASE_FONT = "Calibri";
    const BASE_FONT_SIZE = 22; // 11pt font size

    // --- Helper functions for creating Word elements ---
    const H1 = (text) => new Paragraph({
        text,
        heading: HeadingLevel.HEADING_1,
        shading: { type: ShadingType.CLEAR, color: "C5E0B3", fill: "C5E0B3" },
        spacing: { before: 240, after: 120 }
    });
    const H2 = (text) => new Paragraph({
        text,
        heading: HeadingLevel.HEADING_2,
        shading: { type: ShadingType.CLEAR, color: "E2EFD9", fill: "E2EFD9" },
        spacing: { before: 240, after: 120 }
    });
    const H3 = (text) => new Paragraph({
        text,
        heading: HeadingLevel.HEADING_3,
        shading: { type: ShadingType.CLEAR, color: "FFF2CC", fill: "FFF2CC" },
        spacing: { before: 240, after: 120 }
    });
    const P = (text) => new Paragraph({
        children: [new TextRun({ text: String(text ?? ""), font: BASE_FONT, size: BASE_FONT_SIZE })],
        spacing: { after: 120 }
    });
    
    const P_Bold = (text) => new Paragraph({
        children: [new TextRun({ text: String(text ?? ""), font: BASE_FONT, size: BASE_FONT_SIZE, bold: true })],
        spacing: { after: 120 },alignment: AlignmentType.CENTER
    });
    
    // --- Helper function to create an issue table ---
    function createIssueTable(issues) {
        if (!issues.length || !issues.some(i => i.issue || i.cause)) {
            return null;
        }
        const rows = [
            new TableRow({
                tableHeader: true,
                children: [
                    new TableCell({ children: [P_Bold("Issue")], shading: { fill: "70AD47" } }),
                    new TableCell({ children: [P_Bold("What is the cause of this issue and how can it be resolved")], shading: { fill: "70AD47" } }),
                ]
            }),
            ...issues.filter(i => i.issue || i.cause).map((item, index) => {
                const shading = index % 2 === 1 ? { fill: "E2EFD9", type: ShadingType.CLEAR } : {};
                return new TableRow({
                    children: [
                        new TableCell({ children: [P(item.issue)], shading: shading }),
                        new TableCell({ children: [P(item.cause)], shading: shading }),
                    ]
                });
            })
        ];
        return new Table({ rows, width: { size: 100, type: WidthType.PERCENTAGE } });
    }

    const data = getPlanData();

    // --- Define the document footer ---
    const footer = new Footer({
        children: [
            new Paragraph({
                alignment: AlignmentType.LEFT,
                children: [
                    new TextRun({ children: [PageNumber.CURRENT], font: "Calibri Light", size: 20,bold: true, }),
                    new TextRun({ text: " | J S B", font: "Calibri Light", size: 20 })
                ]
            })
        ]
    });

    // --- Build the document section by section, matching the template ---
    const docChildren = [];
   // --- Create Title Page Content ---
    const titlePageChildren = [];
    
     // Add image to title page if URL exists
    if (data.imageUrl) {
        try {
            const resp = await fetch(data.imageUrl);
            const blob = await resp.blob();
            const imageBuffer = await blob.arrayBuffer();
            titlePageChildren.push(new Paragraph({
                alignment: AlignmentType.CENTER,
                children: [new ImageRun({ data: imageBuffer, transformation: { width: 450, height: 253 } })],
            }));
        } catch (e) {
            console.warn("Image could not be loaded.", e);
            titlePageChildren.push(P("[Image could not be loaded from the provided URL]"));
        }
    }

    titlePageChildren.push(
        new Paragraph({ spacing: { before: 200 } }), // Top margin
        new Paragraph({
            alignment: AlignmentType.CENTER,
            children: [
                new TextRun({
                    text: data.bizName,
                    bold: true,
                    size: 66, // 33pt font size
                    font: "Calibri Light",
                    color: "9CC2E5",
                }),
            ],
        }),
        new Paragraph({
            alignment: AlignmentType.CENTER,
            children: [
                new TextRun({
                    text: "Strategic Business Plan",
                    size: 66, // 33pt font size
                    font: "Calibri",
                    color: "9CC2E5",
                }),
            ],
            spacing: { after: 200 }
        }),
      )

    // Add author and date to bottom of title page
    const currentDate = new Date().toLocaleDateString('en-AU', { year: 'numeric', month: 'long', day: 'numeric' });
    titlePageChildren.push(new Paragraph({ spacing: { before: 100 } })); // Push to bottom
    titlePageChildren.push(new Paragraph({
        alignment: AlignmentType.CENTER,
        text: `Prepared by: ${data.authorName}`,
        style: "Well Spaced"
    }));
    titlePageChildren.push(new Paragraph({
        alignment: AlignmentType.CENTER,
        text: `Date: ${currentDate}`,
        style: "Well Spaced"
    }));

    // --- Add Title Page and subsequent Page Break to the document ---
    docChildren.push(...titlePageChildren);
    docChildren.push(new Paragraph({ pageBreakBefore: true }));

    // --- Create and insert the Table of Contents ---
    docChildren.push(new Paragraph({ text: "Table of Contents", heading: HeadingLevel.HEADING_1 }));
    docChildren.push(new TableOfContents("Table of Contents", { hyperlink: true }));
    docChildren.push(P("")); // Add a space after the TOC
    docChildren.push(new Paragraph({ pageBreakBefore: true }));

    // << EXECUTIVE SUMMARY >>
    docChildren.push(H1("EXECUTIVE SUMMARY"));
    const execSummaryIntro = `${data.bizName} Trading as ${data.tradingName} is a ${data.bizType} business based in ${data.geo}. We offer a range of services to ${data.primaryMarket} in the ${data.primaryArea} primarily and ${data.secondaryArea} generally.`;
    docChildren.push(P(execSummaryIntro));
    if (data.imageUrl) {
        try {
            const resp = await fetch(data.imageUrl);
            const blob = await resp.blob();
            const imageBuffer = await blob.arrayBuffer();
            docChildren.push(new Paragraph({
                alignment: AlignmentType.CENTER,
                children: [new ImageRun({ data: imageBuffer, transformation: { width: 520, height: 300 } })],
            }));
        } catch (e) {
            console.warn("Image could not be loaded. Ensure the URL is correct and allows direct access.", e);
            docChildren.push(P("[Image could not be loaded from the provided URL]"));
        }
    }
    // Static paragraphs from template
    docChildren.push(P("Our strategic purpose is driven by our customers‚Äô needs, our stakeholder expectations, and our values."));
    docChildren.push(P("To achieve our strategic objective, we have completed a strategic review and have prioritised issues identified. From here we have and set clear achievable goals and action plans to achieve these goals. Progress on achieving these goals and the overall strategic objective is reviewed ongoing and new short-term goals that are in line with the strategic objective are set every three months. We have engaged the support of a Strategic Advisor to assist us to stay the course."));

    // Dynamic Business Description <<15>>
    if (data.businessDescription) docChildren.push(P(data.businessDescription));

    // << STRATEGIC OVERVIEW >>
    docChildren.push(H1("STRATEGIC OVERVIEW"));
    const overviewIntro = `${data.tradingName} has been operating since ${data.firstYear} and offers an extensive range of services to clients in our target market area of ${data.primaryArea}.`;
    docChildren.push(P(overviewIntro));
    // Dynamic Business Background <<17>> and Service Intent <<18>>
    if (data.background) docChildren.push(P(data.background));
    if (data.serviceIntent) docChildren.push(P(data.serviceIntent));
    // Static paragraphs from template
    docChildren.push(P("In preparing this comprehensive strategic plan, a comprehensive strategic analysis was conducted, including a review of our purpose and strategic direction both of which are informed by our values stakeholder need."));
    docChildren.push(P("This analysis included an examination of our internal strengths and weaknesses, as well as external opportunities and threats. We have looked at them by way of the positive attributes (Strengths and Opportunities) and challenges to overcome (Weakness and Threats). These have been identified in each strategic area of the business; Customer (Sales), Finance, Operations, Learning and Growth. In undertaking this strategic analysis process, we also considered the external environment (Political, Economic Social and Technological- PEST)"));
    docChildren.push(P("We also evaluated our current position in the market and our competition. All this information informs our strategic goals and objectives and will continue to guide our decision-making and actions moving forward."));
    docChildren.push(P("From this work we have prioritized issues using a version of the ‚ÄúUrgent-Important Matrix‚Äù also known as the ‚ÄúEisenhower Matrix‚Äù. This has assisted in the decision making to address important/Urgent issues as a priority, scheduling Urgent/Not Important, Delegate Not Urgent/Important and deferring or deleting Not Important/Not urgent issues."));
    docChildren.push(P("This assists us to decide on and prioritize tasks by urgency and importance, sorting out less urgent and important tasks which we should either delegate or not do at all."));
    docChildren.push(P("This work serves as the foundation for our strategic goals and objectives. By adopting a forward-looking approach, we are now able to leverage the identified strengths and opportunities while proactively addressing challenges posed. This information not only shapes our strategic roadmap but also acts as an ongoing compass, informing and guiding our decision-making processes and actions as we navigate the dynamic landscape ahead."));
    docChildren.push(P("Our commitment to strategic excellence ensures that our organization remains agile, adaptive, and aligned with the ever-evolving demands of our industry and the expectations of our valued customers."));

    // << Strategic Purpose >>
    docChildren.push(H2("Strategic Purpose- Why does the business exist."));
    if (data.purpose) docChildren.push(P(`${data.tradingName}‚Äôs ${data.purpose}`));
    
    // << Strategic Direction >>
    docChildren.push(H2("Strategic Direction ‚Äì Where are we going, what is our big goal?"));
    const directionText = `In ${data.planningPeriod}, ${data.tradingName} will ${data.planningGoal} under management by ${data.detailedPeriod}, with ${data.detailedGoal} under management by ${data.detailedPeriod}`;
    docChildren.push(P(directionText));
    
    // << Our Values >>
    docChildren.push(H2("Our Values"));
    if (data.valuesStatement) docChildren.push(P(data.valuesStatement));
    data.values.forEach((row, i) => {
        if (!row.v && !row.p && !row.b) return; // Skip empty rows
        docChildren.push(H3(`Value ${i + 1}: ${row.v || ''}`));
        if (row.p) docChildren.push(P(`${row.p}`)); // << Principle >>
        if (row.b) docChildren.push(P(`${row.b}`)); // << Behaviour >>
    });

    // << Our Stakeholders >>
    docChildren.push(H2("Our Stakeholders"));
    if (data.stakeholderStatement) docChildren.push(P(data.stakeholderStatement));
    data.stakeholders.forEach(s => {
        if (!s.who && !s.stake) return; // Skip empty rows
        docChildren.push(P(s.who)); // << Stakeholder Name >>
        docChildren.push(P(s.stake)); // << Stakeholder's stake >>
    });

    // << Strategic Analysis ‚Äì What is Happening Now! >>
    docChildren.push(H2("Strategic Analysis ‚Äì What is Happening Now!"));
    docChildren.push(P("To achieve our ‚ÄúBig Goal‚Äù and having identified all the issues and attributes that confront the company they have been considered using a cause-and-effect analysis to identify and prioritise in order of impact on the success of the business through the development of specific objectives (goals). The high priority issues to be addressed in each area of the business are as follows: "));
    
    // << Sales >>
    docChildren.push(H3("Sales"));
    docChildren.push(P("In the sales environment the high priority areas identified in the strategic analysis are outlined below. These issues have been specifically addressed in the goals as outlined further in this document."));
    const salesTable = createIssueTable(data.salesIssues);
    if (salesTable) docChildren.push(salesTable);

    // << Finance >>
    docChildren.push(H3("Finance"));
    docChildren.push(P("In the financial environment the high priority areas identified in the strategic analysis are outlined below. These issues have been specifically addressed in the goals as outlined further in this document."));
    const financeTable = createIssueTable(data.financeIssues);
    if (financeTable) docChildren.push(financeTable);
    
    // << Operations >>
    docChildren.push(H3("Operations"));
    docChildren.push(P("In the operational area of the business the high priority areas identified in the strategic analysis are outlined below. These issues have been specifically addressed in the goals as outlined further in this document."));
    const operationTable = createIssueTable(data.operationIssues);
    if (operationTable) docChildren.push(operationTable);

    // << Learning >>
    docChildren.push(H3("Learning"));
    docChildren.push(P(`Learning is important to ${data.tradingName}. The high priority areas identified in the strategic analysis are outlined below. These issues have been specifically addressed in the goals as outlined further in this document.`));
    const learningTable = createIssueTable(data.learningIssues);
    if (learningTable) docChildren.push(learningTable);

    // << Growth >>
    docChildren.push(H3("Growth"));
    docChildren.push(P(`Growth is important to ${data.tradingName}. The high priority areas identified in the strategic analysis are outlined below. These issues have been specifically addressed in the goals as outlined further in this document.`));
    const growthTable = createIssueTable(data.growthIssues);
    if (growthTable) docChildren.push(growthTable);
    //page break
    docChildren.push(new Paragraph({ pageBreakBefore: true }));
    

    
// --- Assemble the final document ---
    const doc = new Document({
        sections: [{
            properties: {
                page: { margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } } // 1 inch margins
            },
            footers: { default: footer },
            children: docChildren,
        }],
        styles: {
            default: {
                document: {
                    run: { font: BASE_FONT, size: BASE_FONT_SIZE },
                    paragraph: { spacing: { line: 276, before: 198, after: 198 } }
                }
            }
        }
    });

    // --- Trigger the download ---
    const blob = await Packer.toBlob(doc);
    const a = document.createElement('a');
    const safeFileName = (data.tradingName || data.bizName || "Strategic_Plan").replace(/[^\w\s-]/g, '').trim().replace(/\s+/g, '_');
    a.href = URL.createObjectURL(blob);
    a.download = `${safeFileName}_Strategic_Plan.docx`;
    a.click();
    URL.revokeObjectURL(a.href);
});
</script>
</body>
</html>

